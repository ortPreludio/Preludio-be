# Preludio API ‚Äì Backend de gesti√≥n de eventos y ticketing

Backend en Node.js para una plataforma de **gesti√≥n de eventos**, **venta de tickets** y **pagos**, pensado para ser consumido por un frontend (SPA) y para ofrecer endpoints claros y consistentes.

La API permite:

- Registrar y autenticar usuarios (con roles **ADMIN** y **USUARIO**).
- Administrar eventos (crear, listar, editar, borrar).
- Vender tickets asociados a eventos y usuarios.
- Registrar pagos de tickets (checkout).
- Gestionar rese√±as de la aplicaci√≥n (una por usuario).
- Exponer listados con **paginaci√≥n, orden y b√∫squeda simple**.

---

## üß† ¬øQu√© hace y c√≥mo funciona?

### Flujo general

1. **Autenticaci√≥n**
   - Un usuario se registra mediante `/api/auth/register`.
   - El login se realiza en `/api/auth/login`.
   - Se emiten:
     - Un **access token** (JWT de corta duraci√≥n).
     - Un **refresh token** (JWT de mayor duraci√≥n).
   - Los tokens se devuelven en **cookies HTTP** y/o en el cuerpo de la respuesta (seg√∫n el endpoint).

2. **Autorizaci√≥n y roles**
   - El middleware `requireAuth` valida el JWT (en header, cookie o query).
   - `requireRole("ADMIN")` / `roleGate("ADMIN")` restringe endpoints de administraci√≥n.
   - `req.user` siempre contiene al menos `{ id, rol }` para usar en controladores.

3. **Gesti√≥n de usuarios**
   - Modelo `User` con:
     - Datos b√°sicos (`nombre`, `apellido`, `dni`, `email`, `telefono`).
     - `rol` (`ADMIN` | `USUARIO`).
     - Relaciones: `comprasRealizadas` (tickets) y `eventosCreados`.
   - El primer usuario con rol `ADMIN` solo se puede crear si no hay otro admin.

4. **Eventos**
   - Modelo `Event` con:
     - Informaci√≥n b√°sica: t√≠tulo, descripci√≥n, fecha/hora.
     - **Ubicaci√≥n embebida** (`UbicacionSchema`: lugar, direcci√≥n, ciudad, provincia, geo opcional).
     - Capacidad, entradas disponibles, estados, categor√≠a, etc.
   - Endpoints permiten:
     - Crear / actualizar / borrar eventos (solo ADMIN).
     - Listar y buscar eventos con filtros (fecha, estado, ubicaci√≥n, etc.).

5. **Tickets**
   - Modelo `Ticket`:
     - `evento` (ref a `Event`).
     - `comprador` (ref a `User`).
     - `tipoEntrada`, `precioPagado`, `fechaCompra`, `codigoQR` (opcional).
     - `estado` (`VALIDO`, `USADO`, `CANCELADO`).
   - L√≥gica de negocio en `ticketsController`:
     - Verifica disponibilidad del evento.
     - Descuenta entradas disponibles.
     - Crea ticket y lo agrega a `comprasRealizadas` del usuario.

6. **Pagos**
   - Modelo `Pago`:
     - `ticket` (ref a `Ticket`).
     - `metodo` (`MERCADO_PAGO`, `TARJETA`, `EFECTIVO`).
     - `monto`, `fechaPago`, `estado` (`PENDIENTE`, `COMPLETADO`, `FALLIDO`).
     - `referenciaExterna` (ID de pasarela, ej. Mercado Pago).
   - Endpoint de checkout:
     - Si recibe `ticketId`: usa un ticket existente.
     - Si no, crea un ticket con `createTicketForUser`.
     - Crea un `Pago` asociado y responde el pago con `ticket` y `comprador` populados.

7. **Rese√±as**
   - Modelo `Review`:
     - `user` (ref a `User` y `unique`: un usuario solo puede dejar una rese√±a).
     - `rating` (1 a 5).
     - `comment` (10 a 500 caracteres).
   - Endpoints:
     - Listar todas / paginadas.
     - Obtener mi rese√±a (`/me/review`).
     - Crear/editar/eliminar mi rese√±a.
     - ADMIN puede editar/eliminar cualquier rese√±a.

8. **Paginaci√≥n y b√∫squeda**
   - Varios listados (`listUsers`, `listPagos`, `listReviews`, etc.) aceptan:
     - `page` ‚Äì p√°gina actual (1 por defecto).
     - `limit` ‚Äì registros por p√°gina.
     - `sort` ‚Äì campo por el que se ordena.
     - `order` ‚Äì `asc` o `desc`.
     - `q` ‚Äì texto de b√∫squeda simple sobre ciertos campos.
   - Internamente se calcula:
     - `skip = (page - 1) * limit`.
   - La respuesta incluye siempre al menos:
     - `items` ‚Äì array de resultados.
     - `total` ‚Äì cantidad total de registros que matchean el filtro.
     - `page`, `limit`.

---

## üèóÔ∏è Arquitectura del proyecto

Estructura principal:

```txt
server.js
src/
  config/
    db.js          # Conexi√≥n y selecci√≥n de base seg√∫n entorno
  controllers/
    authController.js
    usersController.js
    eventController.js
    ticketsController.js
    pagosController.js
    reviewController.js
  middlewares/
    auth.js        # requireAuth, requireRole, optionalAuth
  models/
    User.js
    Event.js
    Ticket.js
    Pago.js
    Review.js
    TipoEntrada.js
  routes/
    authRoutes.js
    userRoutes.js
    eventsRoutes.js
    ticketsRoutes.js
    pagosRoutes.js
    reviewRoutes.js
    index.js       # monta /auth, /users, /events, /reviews, /tickets, /pagos
  data/
    users.js       # datos de ejemplo
```

### Flujo de arranque

1. `server.js`:
   - Carga variables de entorno (`dotenv`).
   - Inicializa Express.
   - Conecta a MongoDB mediante `conectarDB()` (`src/config/db.js`).
   - Configura middlewares globales:
     - `cors` con `origin = process.env.FRONT`.
     - `cookieParser` para leer JWT en cookies.
     - `express.json()` para parsear JSON.
   - Monta rutas:
     - `/api` ‚Üí `apiRouter` (auth, users, events, reviews, tickets, pagos).
   - Levanta el servidor en `PORT`.

2. `conectarDB()`:
   - Usa `MONGODB_URI` (solo cluster, sin nombre de DB).
   - Elige `dbName` seg√∫n:
     - `APP_ENV` / `NODE_ENV` (`production` vs `staging`).
     - `DB_NAME_PROD` / `DB_NAME_STAGING`.
     - Flag opcional `--db=NombreDB` al ejecutar `node`.
   - Habilita `mongoose.set('strictQuery', true);`.
   - Se conecta y loguea `[DB] conectado a "..." (env=...)`.

3. Middlewares de auth (`src/middlewares/auth.js`):
   - `extractToken` soporta:
     - Header `Authorization: Bearer ...`.
     - Header `x-access-token`.
     - Cookie `token`.
     - Query `?access_token=` / `?token=`.
   - `requireAuth` verifica el JWT y setea `req.user`.
   - `requireRole(...roles)` verifica el rol.
   - `optionalAuth` no falla si no hay token (√∫til para endpoints p√∫blicos).

---

## üîß Tecnolog√≠as utilizadas

- **Node.js** (ES Modules)
- **Express** ‚Äì servidor HTTP y ruteo.
- **MongoDB** + **Mongoose** ‚Äì base de datos y modelos ODM.
- **JWT (jsonwebtoken)** ‚Äì autenticaci√≥n basada en tokens.
- **bcryptjs** ‚Äì hash de contrase√±as.
- **dotenv** ‚Äì configuraci√≥n mediante `.env`.
- **cors** ‚Äì configuraci√≥n de CORS para el frontend.
- **cookie-parser** ‚Äì lectura de cookies (tokens).
- JavaScript moderno (async/await, import/export, optional chaining, etc.).

---

## ‚úÖ Requisitos previos

- Node.js >= 18 (recomendado).
- MongoDB (local o cluster en Atlas).
- npm o pnpm/yarn (seg√∫n prefieras).
- Un frontend o herramienta tipo Postman/Insomnia para probar la API.

---

## ‚öôÔ∏è Configuraci√≥n de entorno

Crear un archivo `.env` en la ra√≠z del proyecto con, por ejemplo:

```env
# Servidor
PORT=3001
FRONT=http://localhost:5173

# MongoDB
MONGODB_URI=mongodb+srv://usuario:password@cluster.mongodb.net
APP_ENV=staging
DB_NAME_STAGING=preludio_staging
DB_NAME_PROD=preludio_prod

# JWT
JWT_SECRET=super_secret_access_key
JWT_REFRESH_SECRET=super_secret_refresh_key
```

Notas:

- `MONGODB_URI` **no** debe incluir el nombre de la base al final, solo el cluster.
- `APP_ENV` controla qu√© DB se elige (staging vs production).
- `JWT_SECRET` y `JWT_REFRESH_SECRET` deben ser claves seguras y distintas.

---

## üèÉ‚Äç‚ôÇÔ∏è C√≥mo ejecutar en local

1. **Clonar el repositorio**

```bash
git clone https://github.com/tu-usuario/tu-repo.git
cd tu-repo
```

2. **Instalar dependencias**

```bash
npm install
# o
pnpm install
# o
yarn install
```

3. **Configurar `.env`**

Crear el archivo `.env` como se indic√≥ arriba.

4. **Levantar el servidor**

Seg√∫n c√≥mo tengas definido `package.json`, por ejemplo:

```bash
npm start
# o
node server.js
# o
npm run dev
```

5. **Probar la API**

- Healthcheck:
  - `GET http://localhost:3001/api/health`
- Auth:
  - `POST http://localhost:3001/api/auth/register`
  - `POST http://localhost:3001/api/auth/login`
- Eventos:
  - `GET http://localhost:3001/api/events`
- Tickets:
  - `POST http://localhost:3001/api/tickets`
- Pagos:
  - `POST http://localhost:3001/api/pagos/checkout`

---

## üîå Endpoints principales (resumen)

### Autenticaci√≥n (`/api/auth`)

- `POST /register` ‚Äì Registro de usuario.
- `POST /login` ‚Äì Login con email y password (devuelve tokens y user).
- `POST /logout` ‚Äì Cierra sesi√≥n (limpia cookies).
- `GET /me` ‚Äì Devuelve al usuario autenticado (requiere token).

### Usuarios (`/api/users`)

- `GET /admin` ‚Äì (ADMIN) listado paginado de usuarios.
- `POST /` ‚Äì (ADMIN) crear usuario.
- `GET /me` ‚Äì datos del usuario logueado.
- `PATCH /me` ‚Äì actualizar datos propios.
- `PUT /me/profile` ‚Äì actualizar perfil propio.
- `PUT /me/change-password` ‚Äì cambiar contrase√±a propia.
- `GET /search` ‚Äì b√∫squeda simple de usuarios.
- `GET /:id` ‚Äì detalle de usuario (seg√∫n permisos).
- `PUT /:id` ‚Äì (ADMIN) actualizar usuario por ID.

### Eventos (`/api/events`)

- `GET /` ‚Äì listar/buscar eventos con filtros y paginaci√≥n.
- `GET /:id` ‚Äì detalle de evento.
- `POST /` ‚Äì (ADMIN) crear evento.
- `PUT /:id` ‚Äì (ADMIN) actualizar evento.
- `DELETE /:id` ‚Äì (ADMIN) eliminar evento.

### Tickets (`/api/tickets`)

- `POST /` ‚Äì crear ticket (compra usuario o creaci√≥n por admin).
- `GET /` ‚Äì listar tickets del usuario autenticado.
- `GET /:id` ‚Äì obtener ticket por ID.

### Pagos (`/api/pagos`)

- `POST /checkout` ‚Äì crear pago asociado a un ticket (y opcionalmente crear el ticket).
- `GET /:id` ‚Äì obtener pago por ID.
- `GET /list` ‚Äì listado paginado de todos los pagos (solo ADMIN).
- `GET /` ‚Äì listado paginado de mis pagos (usuario logueado).

### Rese√±as (`/api/reviews`)

- `GET /` ‚Äì obtener todas las rese√±as (sin paginaci√≥n).
- `GET /list` ‚Äì listar rese√±as con paginaci√≥n y b√∫squeda.
- `GET /:id` ‚Äì obtener rese√±a por ID.
- `GET /me/review` ‚Äì obtener mi rese√±a.
- `POST /` ‚Äì crear mi rese√±a (solo una por usuario).
- `PUT /me` ‚Äì actualizar mi rese√±a.
- `DELETE /me` ‚Äì eliminar mi rese√±a.
- `PUT /:id` ‚Äì (ADMIN) actualizar rese√±a de cualquier usuario.
- `DELETE /:id` ‚Äì (ADMIN) eliminar rese√±a de cualquier usuario.

---

## üîë Credenciales de prueba (completar)

```text
ADMIN
- Email: admin@preludio.com
- Password: Password01!

USUARIO
- Email: usuario@preludio.com
- Password: Password01!
```
